<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeCats - Edit Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.3/cdn.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#841327',
                    secondary: '#a31e23',
                    catdark: '#2b2b2b',
                    catlight: '#fad129',
                }
            }
        }
    }
</script>
</head>
<body class="bg-primary min-h-screen font-sans">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center space-x-4">
                    <span class="text-primary text-2xl font-bold ml-2">WeCats</span>
                </div>
                
    </nav>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto mt-6 px-4">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Edit Profile</h1>
                <a href="dashboard.html" class="text-catdark hover:text-blue-800">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
                </a>
            </div>

            <form id="edit-profile-form" class="space-y-6">
                <!-- Profile Picture Section -->
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6">
                    <div class="flex-shrink-0">
                        <div class="relative group">
                            <img src="/api/placeholder/150/150" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-blue-500">
                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition cursor-pointer">
                                <label for="profile-pic" class="text-white cursor-pointer">
                                    <i class="fas fa-camera text-xl"></i>
                                    <span class="block text-sm mt-1">Change</span>
                                </label>
                            </div>
                            <input type="file" id="profile-pic" name="profile-pic" class="hidden" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="flex-grow">
                        <h2 class="text-xl font-semibold text-gray-700">Profile Picture</h2>
                        <p class="text-gray-500 text-sm mt-1">Upload a new profile picture. JPG, PNG or GIF. Max 5MB.</p>
                        <div class="mt-3 flex space-x-3">
                            <button type="button" id="upload-trigger" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-blue-700 transition">
                                Upload New
                            </button>
                        </div>
                    </div>
                </div>

                <hr class="my-6">

                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nickname" class="block text-sm font-medium text-gray-700 mb-1">Nickname</label>
                        <input type="text" id="nickname" name="nickname" ...
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address (Cannot be changed)</label>
                        <input type="email" id="email" name="email" diasbled ... 
                            class="w-full px-4 py-2 border border-gray-200 rounded-md bg-gray-100" disabled>
                    </div>
                    
                    <div>
                        <label for="id-number" class="block text-sm font-medium text-gray-700 mb-1">ID Number</label>
                        <input type="text" id="id-number" name="id-number" ... 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="program" class="block text-sm font-medium text-gray-700 mb-1">Year and Program</label>
                        <input type="text" id="program" name="program" ...
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select id="gender" name="gender" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="male">Male</option>
                            <option value="female" selected>Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                        <textarea id="bio" name="bio" rows="3" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <hr class="my-6">

                <!-- Password Change -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800">Change Password</h3>
                    <p class="text-gray-500 text-sm">Leave blank if you don't want to change your password</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                            <input type="password" id="current-password" name="current-password" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div></div>
                        
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                            <input type="password" id="new-password" name="new-password" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                            <input type="password" id="confirm-password" name="confirm-password" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <hr class="my-6">

                <!-- Save Button -->
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 transition">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-secondary text-white font-medium rounded-md hover:bg-blue-700 transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white mt-12 py-6 border-t">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <span class="text-gray-800 text-xl font-bold ml-2">WeCats</span>
                    <p class="text-gray-600 text-sm mt-1">Â© 2025 WeCats. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

<script type="module">
import { supabase } from './supabase.js';
console.log("Profile script loaded!");

// --- ENCRYPTION HELPERS (AES-GCM) ---
// Derive a key from a passphrase (for demo, use userId as passphrase)
async function getKey(passphrase) {
    const enc = new TextEncoder();
    const keyMaterial = await window.crypto.subtle.importKey(
        "raw", enc.encode(passphrase), { name: "PBKDF2" }, false, ["deriveKey"]
    );
    return window.crypto.subtle.deriveKey(
        {
            name: "PBKDF2",
            salt: enc.encode("wecats-salt"), // use a constant salt for demo
            iterations: 100000,
            hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
    );
}
// Encrypt text
async function encryptText(key, text) {
    const enc = new TextEncoder();
    const iv = window.crypto.getRandomValues(new Uint8Array(12));
    const ciphertext = await window.crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(text)
    );
    // Return base64 encoded iv + ciphertext
    return btoa(String.fromCharCode(...iv) + String.fromCharCode(...new Uint8Array(ciphertext)));
}
// Decrypt text
async function decryptText(key, data) {
    const raw = atob(data);
    const iv = Uint8Array.from(raw.slice(0, 12), c => c.charCodeAt(0));
    const ciphertext = Uint8Array.from(raw.slice(12), c => c.charCodeAt(0));
    const dec = new TextDecoder();
    const plain = await window.crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        key,
        ciphertext
    );
    return dec.decode(plain);
}

// Logout handler
const logoutBtn = document.getElementById('logout-btn');
if (logoutBtn) {
    logoutBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    });
}

// Elements
const form = document.getElementById('edit-profile-form');
const profilePicInput = document.getElementById('profile-pic');
const profileImg = document.querySelector('.w-32.h-32.rounded-full');
const uploadTrigger = document.getElementById('upload-trigger');
const cancelBtn = document.getElementById('cancel-btn');

// Form fields
const nicknameInput = document.getElementById('nickname');
const emailInput = document.getElementById('email');
const idNumberInput = document.getElementById('id-number');
const programInput = document.getElementById('program');
const genderInput = document.getElementById('gender');
const bioInput = document.getElementById('bio');
const currentPasswordInput = document.getElementById('current-password');
const newPasswordInput = document.getElementById('new-password');
const confirmPasswordInput = document.getElementById('confirm-password');

let profilePictureUrl = null;
let userId = null;

// Helper: Show alert
function showAlert(msg) {
    window.alert(msg);
}

// Load profile data
async function loadProfile() {
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    if (!session) {
        window.location.href = 'index.html';
        return;
    }
    userId = session.user.id;
    emailInput.value = session.user.email;

    // Fetch profile
    const { data: profile, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();
    if (error || !profile) {
        showAlert('Failed to load profile.');
        return;
    }
    nicknameInput.value = profile.nickname || '';
    idNumberInput.value = profile.id_number || '';
    programInput.value = profile.year_program || '';
    genderInput.value = profile.gender || '';
    profilePictureUrl = profile.profile_picture_url || '';
    if (profilePictureUrl) {
        profileImg.src = profilePictureUrl + '?t=' + new Date().getTime();
    }
    // Decrypt bio
    if (profile.bio) {
        try {
            const key = await getKey(userId);
            bioInput.value = await decryptText(key, profile.bio);
        } catch (err) {
            bioInput.value = '[Unable to decrypt]';
        }
    } else {
        bioInput.value = '';
    }
}

// Upload profile picture to Supabase Storage
async function uploadProfilePicture(file) {
    if (!file) return null;
    const ext = file.name.split('.').pop();
    const filePath = `profile-pictures/${userId}_${Date.now()}.${ext}`;
    const { error: uploadError } = await supabase.storage
        .from('profile-pictures')
        .upload(filePath, file, { upsert: true });
    if (uploadError) {
        showAlert('Failed to upload profile picture: ' + uploadError.message);
        return null;
    }
    const { data } = supabase.storage.from('profile-pictures').getPublicUrl(filePath);
    return data.publicUrl;
}

// Handle image preview
profilePicInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            profileImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Connect upload button to hidden file input
uploadTrigger.addEventListener('click', function() {
    profilePicInput.click();
});

// Cancel button
cancelBtn.addEventListener('click', function() {
    window.location.href = 'profile.html';
});

// Form submission
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Form submitted');
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    if (newPassword && newPassword !== confirmPassword) {
        showAlert('New password and confirmation do not match!');
        return;
    }
    let newProfilePicUrl = profilePictureUrl;
    if (profilePicInput.files[0]) {
        newProfilePicUrl = await uploadProfilePicture(profilePicInput.files[0]);
        if (!newProfilePicUrl) {
            console.log('Profile picture upload failed');
            return;
        }
        // Update preview immediately with cache busting
        profileImg.src = newProfilePicUrl + '?t=' + new Date().getTime();
    }
    // Encrypt bio before saving
    const key = await getKey(userId);
    const encryptedBio = await encryptText(key, bioInput.value.trim());
    const updates = {
        nickname: nicknameInput.value.trim(),
        id_number: idNumberInput.value.trim(),
        year_program: programInput.value.trim(),
        gender: genderInput.value,
        bio: encryptedBio,
        profile_picture_url: newProfilePicUrl
    };
    console.log('Attempting to update profile with:', updates, 'for userId:', userId);
    const { error: updateError } = await supabase
        .from('profiles')
        .update(updates)
        .eq('id', userId);
    if (updateError) {
        showAlert('Failed to update profile: ' + updateError.message);
        console.error('Supabase update error:', updateError);
        return;
    }
    if (newPassword) {
        // Check for valid session before updating password
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            showAlert('You are not logged in. Please log in again.');
            window.location.href = 'index.html';
            return;
        }
        const { error: pwError } = await supabase.auth.updateUser({ password: newPassword });
        if (pwError) {
            showAlert('Failed to change password: ' + pwError.message);
            console.error('Supabase password error:', pwError);
            return;
        }
    }
    showAlert('Profile updated successfully!');
    window.location.href = 'profile.html';
});

// On load
loadProfile();
</script>

</body>
</html>